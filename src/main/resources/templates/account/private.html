<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
<meta charset="UTF-8">
<meta th:name="_csrf" th:content="${_csrf.token}"/>
<meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>
<title>Personal area</title>
	<link th:rel="stylesheet" th:href="@{/webjars/bootstrap/5.1.3/css/bootstrap.min.css}"/>
	<link th:rel="stylesheet" th:href="@{/css/stylish.css}">	
	<script th:src="@{/webjars/jquery/3.6.0/jquery.min.js}"></script>
	<script th:src="@{/webjars/popper.js/2.9.3/umd/popper.min.js}"></script>
	<script th:src="@{/webjars/bootstrap/5.1.3/js/bootstrap.min.js}"></script>	
<!-- 	<style>.error {color: red; font-weight: bold;}</style> -->
</head>
<body>

<div class="container pt-5">
<h3>Personal area</h3>
<hr>
<br>
	<p th:text="${account.name} + ' ' + ${account.surname}"/>
	<p sec:authentication="principal.authorities"/>
<form th:action="@{/accounts/password/{phone}(phone=${account.phone})}" method="get">
	<button type="submit" class="btn btn-secondary">Change password</button>
</form>
<br>

<div sec:authorize="hasRole('ADMIN')">
	<a th:href="@{/accounts/search}">
	<button type="button">Admin's</button></a>
</div>
<hr>
<br>

<div>
<table class="table table-hover table-sm">
	<thead id="bill_head">
		<tr>
			<th style="text-align: center;">Id</th>
			<th style="text-align: center;">Balance</th>
			<th style="text-align: center;">Currency</th>
			<th style="text-align: center;">Active</th>			
			<th style="text-align: center;">Actions</th>
			<th></th>
		</tr>
	</thead>
	<tbody id="bill_body">
		<tr th:each="bill: ${account.bills}">
			<td class="align-middle" align="center" th:text="${bill.id}"></td>
		    <td class="align-middle" align="center" th:text="${bill.balance}"></td>
		    <td class="align-middle" align="center" th:text="${bill.currency}"></td>
		    <td class="align-middle" align="center" th:text="${bill.active}"></td>	    
		    	    
		    <td class="align-middle" align="center" th:if="${bill.active}">
		    <div>
				<form th:action="@{/bills/operate/{id}(id=${bill.id})}" method="post">
				<input type="hidden" th:name="balance" th:value="${bill.balance}"/>
				
			    <button type="submit" th:name="action" th:value="deposit" class="btn btn-primary">
			    Deposit</button>
			    <button type="submit" th:name="action" th:value="withdraw" class="btn btn-info">
			    Withdraw</button>
			    <button type="submit" th:name="action" th:value="transfer" class="btn btn-warning">
			    Transfer</button>
	
				</form>
			</div>
			</td>
			<td th:if="${bill.active}">
				<form th:action="@{/accounts/show/{phone}(phone=${account.phone})}"
				 th:method="delete">
					<input type="hidden" th:name="id" th:value="${bill.id}"/>					
						<button class="btn btn-danger"
						onclick="if (!(confirm('Are you sure to delete this bill?')))
						return false">Erase</button>
				</form>
			</td>    
		</tr>
	</tbody>
</table>
</div>
<br>

<!-- <form th:action="@{/accounts/show}" method="post">
        <select class="form-control" id="currency" th:name="currency" style="width:auto" required>
            <option value="">Select currency</option>
            <option th:each="currency : ${T(com.github.irybov.bankdemoboot.Currency).values()}"
                    th:value="${currency.name()}"
                    th:text="${currency.name()}">
            </option>
        </select>
		<button type="submit" class="btn btn-success">
			Add new bill</button>

	<p th:text="${message}" th:value="${#strings.isEmpty('currency')}" class="error"/>
</form> -->
<div>
<form id="currency_form">
        <select class="form-control" th:id="currency" style="width:auto" required>
            <option value="">Select currency</option>
            <option th:each="currency : ${T(com.github.irybov.bankdemoboot.Currency).values()}"
                    th:value="${currency.name()}"
                    th:text="${currency.name()}">
            </option>
        </select>
    <input type="hidden" th:id="account_phone" th:value="${account.phone}"/>    
	<button type="submit" class="btn btn-success add_bill">
		Add new bill</button>
</form>
</div>
<br>

<form th:action="@{/logout}" method="post">
	<input type="submit" th:value="LogOut" class="btn btn-warning"/>
</form>
</div>

<script>
    $(document).ready(function(){
        $('#currency_form').submit(function (ev) {
            ev.preventDefault();
            var phone = $('#account_phone').val();
            var type = $('#currency').val();
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");
            var requestHeaders = {};
            requestHeaders[header] = token;
            $.ajax({
                type: 'POST',
                url: 'http://localhost:8080/bankdemo/bills/add', 
                data: {
                	"phone": phone,
                    "currency": type
                },
                headers: requestHeaders,
                success: function(data){
                	var rowID = data.id;
	    	 		var info = '<tr id="row'+rowID+'">'
	   					+ '<td class=align-middle align=center>'+data.id+'</td>'
	   					+ '<td class=align-middle align=center>'+data.balance+'</td>'
	   					+ '<td class=align-middle align=center>'+data.currency+'</td>'
	   					+ '<td class=align-middle align=center>'+data.active+'</td>'
	   					+ '<td class=align-middle align=center><div>'
	   					+'<button class="btn btn-primary submit" value="deposit">Deposit</button>'
	   					+'<button class="btn btn-info submit" value="withdraw">Withdraw</button>'
	   					+'<button class="btn btn-warning submit" value="transfer">Transfer</button>'
	   					+'</div></td>'
	 					+ '<td><button class="btn btn-danger" id="erase'+rowID+'">'
	 					+'Erase</button></td>'
	   					+ '</tr>';
	    		 	$(info).appendTo('#bill_body');
	    		 	
	    		 	var action = $('.submit').val();
	    		 	var balance = data.balance;
    	    		 	var billForm =
							$('<form action="http://localhost:8080/bankdemo/bills/operate/'+rowID+'" method="post">'
   	    		 			+'<input type="hidden" name="action" value="'+action+'"/>'
   	    		 			+'<input type="hidden" name="balance" value="'+balance+'"/></form>');
	    		 	$(billForm).append('<input type="hidden" name="_csrf" value="'+token+'"/>');
	    		 	$('.submit').click(function(){
	    		 		$(billForm).appendTo(document.body);
	    		 		$(billForm).submit();
 	    		 		$(document.body).removeChild(billForm);
	    		 	});
	    		 	
	    		 	var dataRow = '#row'+rowID;
	    		 	var eraseBTN = '#erase'+rowID;
	    			$(eraseBTN).click(function(){
	    				if(!confirm('Are you sure to delete this bill?')){
	                        return false;
	       				}
	    				$.ajax({
	    				    url: 'http://localhost:8080/bankdemo/bills/delete?id='+rowID,
	    				    type: 'DELETE',
	    				    headers: requestHeaders,
	    				    success: function(){
	    				    	$(dataRow).remove();
	    				        return false;
	    				    }
	    				});
	    			});
                }
            });
        });
    });
</script>

</body>
</html>