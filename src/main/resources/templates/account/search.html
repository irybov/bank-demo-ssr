<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
<meta charset="UTF-8">
<title>Admin's area</title>
	<link th:rel="stylesheet" th:href="@{/webjars/bootstrap/5.1.3/css/bootstrap.min.css}"/>
	<link th:rel="stylesheet" th:href="@{/css/stylish.css}">	
	<script th:src="@{/webjars/jquery/3.6.0/jquery.min.js}"></script>
	<script th:src="@{/webjars/popper.js/2.9.3/umd/popper.min.js}"></script>
	<script th:src="@{/webjars/bootstrap/5.1.3/js/bootstrap.min.js}"></script>
<!-- 	<style>.error {color: red; font-weight: bold;}</style>
	<style>input[type=text]:focus{background: #ffe}</style>	 -->
</head>
<body>

<div class="container pt-5">
<h3>Admin's area</h3>
<hr>
<br>
	<p th:text="${admin.name} + ' ' + ${admin.surname}"/>
	<p sec:authentication="principal.authorities"/>
<!-- <form th:action="@{/accounts/password/{phone}(phone=${admin.phone})}" method="get">
	<button type="submit" class="btn btn-secondary">Change password</button>
</form> -->
<div>
<a class="btn btn-secondary" th:href="@{/accounts/password/{phone}(phone=${admin.phone})}"
 target="_blank">Change password</a>
</div>
<br>


<div sec:authorize="hasRole('CLIENT')">
	<a th:href="@{/accounts/show/{phone}(phone=${admin.phone})}">
	<button type="button">Private</button></a>
</div>
<br>

<div sec:authorize="hasRole('ADMIN')">
<input type="button" value="Health" onclick="window.open('/bankdemo/actuator/health', '_blank')">
<input type="button" value="Info" onclick="window.open('/bankdemo/actuator/info', '_blank')">
<input type="button" value="System" onclick="window.open('/bankdemo/actuator/metrics', '_blank')">
</div>
<hr>
<br>

<!-- <div sec:authorize="hasRole('ADMIN')">
<form th:action="@{/accounts/search}" method="get">
	<input type="text" th:name="phone" id="phone" class="form-control" pattern="^[0-9]{10}"
	 placeholder="Phone" required autofocus style="width:auto"/>
	<button type="submit" id="search" class="btn btn-info">Search</button>
</form>	
</div> -->
<div sec:authorize="hasRole('ADMIN')">
<form id="search_form">
	<p th:text="${message}" class="error" id="message"/>
	<input type="text" th:id="phone" class="form-control" pattern="^[0-9]{10}"
	 placeholder="Phone" required autofocus style="width:auto"/>
	<button type="submit" class="btn btn-info" id="search">Search</button>
</form>	
</div>

<hr>
<br>

<!-- <div sec:authorize="hasRole('ADMIN')" th:if="${target}"> -->
<div sec:authorize="hasRole('ADMIN')">
<table class="table table-hover table-sm">
	<thead id="client_head">
		<tr>
			<th style="text-align: center;">Id</th>
			<th style="text-align: center;">Name</th>
			<th style="text-align: center;">Surname</th>
			<th style="text-align: center;">Phone</th>
			<th></th>
			<th style="text-align: center;">Birthday</th>
			<th style="text-align: center;">Active</th>
			<th></th>
		</tr>
	</thead>
	<tbody id="client_body">
<!-- 	<tr>
		<td class="align-middle" align="center" th:text="${target.id}"></td>
	    <td class="align-middle" align="center" th:text="${target.name}"></td>
	    <td class="align-middle" align="center" th:text="${target.surname}"></td>
	    <td class="align-middle" align="center" th:text="${target.phone}"></td>
	    <td></td>
	    <td class="align-middle" align="center"
	     th:text="${#temporals.format(target.birthday, 'yyyy-MM-dd')}"></td>
	    <td class="align-middle" align="center" th:text="${target.active}"
	     th:id="account_bool"></td>
	    
	    <td class="align-middle" align="center">
	    <div>
	    <form th:action="@{/accounts/status/{phone}(phone=${target.phone})}"
			 	th:method="patch" style='display:inline;'>
    			<button type="submit" class="btn btn-danger"
				onclick="if (!(confirm('Are you sure you want to switch the status?')))
				return false">Switch<br/>status</button>
			</form>
			<button type="submit" class="btn btn-danger account_status" th:value="${target.id}"
				onclick="if (!(confirm('Are you sure to switch the status?')))
				return false">Switch<br/>status</button>
		</div>
		</td>
	</tr> -->
	</tbody>
</table>
</div>
<br>

<!-- <div sec:authorize="hasRole('ADMIN')" th:if="${target}"> -->
<div sec:authorize="hasRole('ADMIN')">
<table class="table table-hover table-sm">
	<thead id="bill_head">
		<tr>
			<th style="text-align: center;">Id</th>
			<th style="text-align: center;">Balance</th>
			<th style="text-align: center;">Currency</th>
			<th style="text-align: center;">Active</th>
			<th style="text-align: center;">Actions</th>									
		</tr>
	</thead>
	<tbody id="bill_body">
<!-- 		<tr th:each="bill: ${target.bills}">
			<td class="align-middle" align="center" th:text="${bill.id}"></td>
		    <td class="align-middle" align="center" th:text="${bill.balance}"></td>
		    <td class="align-middle" align="center" th:text="${bill.currency}"></td>
		    <td class="align-middle" align="center" th:text="${bill.active}"
		     th:id="bill_bool + ${bill.id}"></td>
		    
		    <td class="align-middle" align="center">
		    <div>
		    <form style='display:inline;'
		    	 	th:action="@{/bills/status/{phone}(phone=${target.phone})}"
				 	th:method="patch">
					<input type="hidden" th:name="id" th:value="${bill.id}"/>			 
	    			<button type="submit" class="btn btn-danger"
					onclick="if (!(confirm('Are you sure you want to switch the status?')))
					return false">Switch<br/>status</button>
				</form>
				<button type="submit" class="btn btn-danger bill_status" th:value="${bill.id}"
					onclick="if (!(confirm('Are you sure to switch the status?')))
					return false">Switch<br/>status</button>
			<form th:action="@{/operations/list}" method="get" style='display:inline;'>
					<input type="hidden" th:name="id" th:value="${bill.id}"/>
					<input type="hidden" th:name="phone" th:value="${target.phone}"/>			 
		    		<button type="submit" class="btn btn-primary" id="show">
		    		Show<br/>events</button>
				</form>			
	    		<button type="submit" class="btn btn-primary show_events" th:value="${bill.id}">
	    			Show<br/>events</button>
			<form th:action="@{/operations/print}" method="post" style='display:inline;'>
					<input type="hidden" th:name="id" th:value="${bill.id}"/>
					<input type="hidden" th:name="target" th:value="${target.id}"/>
	    			<button type="submit" class="btn btn-success export_csv">
	    			Export<br/>to CSV</button>
				</form>
	    		<button type="submit" class="btn btn-success export_csv" th:value="${bill.id}">
	    			Export<br/>to CSV</button>
			</div>									
			</td>
		</tr> -->
	</tbody>
</table>
</div>
<br>

<script>
	$(document).ready(function(){
        $('#search_form').submit(function (ev) {
            ev.preventDefault();
 			$('#client_body').empty();
 			$('#bill_body').empty();
	 		$.getJSON('http://localhost:8080/bankdemo/accounts/search/'+$('#phone').val(),
	 			function(data){
    	 		var account = '<tr>'
   					+ '<td class=align-middle align=center>'+data.id+'</td>'
   					+ '<td class=align-middle align=center>'+data.name+'</td>'
   					+ '<td class=align-middle align=center>'+data.surname+'</td>'
   					+ '<td class=align-middle align=center>'+data.phone+'</td>'
   					+ '<td></td>'
   				    + '<td class=align-middle align=center>'+data.birthday+'</td>'
   				    + '<td class=align-middle align=center id="target_bool">'+data.active+'</td>'
 					+ '<td><button class="btn btn-danger" id="target_status">Switch<br/>status'
 					+ '</button></td></tr>';
    		 	$(account).appendTo('#client_body');
    		 	
    			$('#target_status').click(function(){
    				if(!confirm('Are you sure to switch the status?')){
                        return false;
       				}
         			$.ajax({
        				type: 'GET',
        				url: 'http://localhost:8080/bankdemo/accounts/status/'+data.id,
         	        	success: function(bool) {
         	        		$('#target_bool').html(bool);
         	        	}
        			});
    			});
    			
	 			$.each(data.bills, function(key, value){
	 				var rowID = value.id;
		 			var info = '<tr id="row'+rowID+'">'
						+ '<td class=align-middle align=center>'+value.id+'</td>'
						+ '<td class=align-middle align=center>'+value.balance+'</td>'
						+ '<td class=align-middle align=center>'+value.currency+'</td>'
						+ '<td class=align-middle align=center id="bill_bool'+rowID+'">'+value.active+'</td>'
						+ '<td class=align-middle align=center>'
	 					+ '<button class="btn btn-danger" id="bill_status'+rowID+'">Switch<br/>status'
	 					+ '</button>'
	 					+ '<button class="btn btn-primary" id="show_events'+rowID+'">Show<br/>events'
	 					+ '</button>'
	 					+ '<button class="btn btn-success" id="export_csv'+rowID+'">Export<br/>to CSV'
	 					+ '</button></td></tr>';
					$(info).appendTo('#bill_body');
					
					var statusBTN = '#bill_status'+rowID;
		 			$(statusBTN).click(function(){
	    				if(!confirm('Are you sure to switch the status?')){
	                        return false;
	       				}
		 				var switcher = '#bill_bool'+rowID;
		 	     			$.ajax({
		 					type: 'GET',
		 					url: 'http://localhost:8080/bankdemo/bills/status/'+rowID,
		 	 	        	success: function(bool) {
		 	 	        		$(switcher).html(bool);
		 	 	        	}
		 				});
		 			});
		 			var eventsBTN = '#show_events'+rowID;
		 	    	$(eventsBTN).click(function(){
		 	 			$('#info_body').empty();
		 		 		$.getJSON('http://localhost:8080/bankdemo/operations/list/'+rowID,
		 		 				function(data){
		 		 			var information = '';
		 		 			$.each(data, function(key, value){
		 						information += '<tr>';
		 						information += '<td align=center>'+value.id+'</td>';
		 						information += '<td align=center>'+value.action+'</td>';
		 						information += '<td></td>';
		 						information += '<td align=center>'+value.amount+'</td>';
		 						information += '<td align=center>'+value.currency+'</td>';
		 						information += '<td align=center>'+value.sender+'</td>';
		 						information += '<td align=center>'+value.recipient+'</td>';
		 						information += '<td></td>';
		 						information += '<td align=center>'+value.timestamp+'</td>';				
		 						information += '</tr>';
		 		 			});
		 			 		$('#info_body').append(information);
		 			    });
		 	 			$('#info_body').hide().fadeIn('slow');
		 		    });
 		 	    	var exportBTN = '#export_csv'+rowID;
		 			$(exportBTN).click(function(){
	 	     			$.ajax({
		 					type: 'GET',
		 					url: 'http://localhost:8080/bankdemo/operations/print/'+rowID,
		 				});
		 			});		 			
	 			});    			
		    })
		    .done(function() { $('#message').empty(); })
		    .fail(function() { $('#message').html
		    	('Account with number: '+$('#phone').val()+' not found'); });
 			$('#client_body').hide().fadeIn('fast');
 			$('#bill_body').hide().fadeIn('slow');
        });            
	});
</script>

<!-- <script>
	$(document).ready(function(){
		$('.account_status').click(function(){
     			$.ajax({
				type: 'GET',
				url: 'http://localhost:8080/bankdemo/accounts/status/'+$(this).val(),
 	        	success: function(bool) {
 	        		$('#account_bool').html(bool);
 	        	}
			});
		});
	});
</script>
<script>
	$(document).ready(function(){
		$('.bill_status').click(function(){
			var switcher = '#bill_bool'+$(this).val();
     			$.ajax({
				type: 'GET',
				url: 'http://localhost:8080/bankdemo/bills/status/'+$(this).val(),
 	        	success: function(bool) {
 	        		$(switcher).html(bool);
 	        	}
			});
		});
	});
</script>
<script>
	$(document).ready(function(){
		$('.export_csv').click(function(){
 			$.get('http://localhost:8080/bankdemo/operations/print/'+$(this).val());
		});
	});
</script>
<script>
	$(document).ready(function(){
    	$('.show_events').click(function(){
 			$('#info_body').empty();
	 		$.getJSON('http://localhost:8080/bankdemo/operations/list/'+$(this).val(),
	 				function(data){
	 			var information = '';
	 			$.each(data, function(key, value){
					information += '<tr>';
					information += '<td align=center>'+value.id+'</td>';
					information += '<td align=center>'+value.action+'</td>';
					information += '<td></td>';
					information += '<td align=center>'+value.amount+'</td>';
					information += '<td align=center>'+value.currency+'</td>';
					information += '<td align=center>'+value.sender+'</td>';
					information += '<td align=center>'+value.recipient+'</td>';
					information += '<td></td>';
					information += '<td align=center>'+value.timestamp+'</td>';				
					information += '</tr>';
	 			});
		 		$('#info_body').append(information);
		    });
 			$('#info_body').hide().fadeIn('slow');
	    });
	});
</script> -->

<!-- <div sec:authorize="hasRole('ADMIN')" th:if="${target}"> -->
<div sec:authorize="hasRole('ADMIN')">
<table class="table table-hover table-sm" id="info_table">
	<thead id="info_head">
		<tr>
			<th style="text-align: center;">Id</th>
			<th style="text-align: center;">Event</th>
			<th></th>
			<th style="text-align: center;">Amount</th>
			<th style="text-align: center;">Currency</th>
			<th style="text-align: center;">From</th>
			<th style="text-align: center;">To</th>
			<th></th>
			<th style="text-align: center;">When</th>
		</tr>
	</thead>
	<tbody id="info_body">
<!-- 	<tr th:each="operation : ${operations}">
		<td align="center" th:text="${operation.id}"></td>		
	    <td align="center" th:text="${operation.action}"></td>
	    <td></td>	    
	    <td align="center" th:text="${operation.amount}"></td>
	    <td align="center" th:text="${operation.currency}"></td>
	    <td align="center" th:text="${operation.sender}"></td>
	    <td align="center" th:text="${operation.recipient}"></td>
	    <td></td>	    	    
	    <td align="center" th:text="${operation.timestamp}"></td>
		</tr> -->
	</tbody>	
</table>
</div>
<br>

<form th:action="@{/logout}" method="post">
	<input type="submit" th:value="LogOut" class="btn btn-warning"/>
</form>
</div>

</body>
</html>